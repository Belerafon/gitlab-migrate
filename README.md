# GitLab CE Migration Toolkit (modular)
    
Модульный набор скриптов для восстановления GitLab CE 13.1.4 из бэкапа и пошагового апгрейда до GitLab 18.x (или выбранной целевой версии) в Docker.

## Структура
```
gitlab-migrate/
  bin/gitlab-migrate.sh          # Точка входа
  conf/settings.env              # Конфигурация
  lib/log.sh                     # Логирование
  lib/state.sh                   # Состояние/диалог
  lib/docker.sh                  # Docker-помощники и ожидания
  lib/dirs.sh                    # Работа с каталогами /srv/gitlab
  lib/backup.sh                  # Импорт, проверка и восстановление бэкапа
  lib/upgrade.sh                 # «Лестница» версий
```

Скрипт поднимает GitLab через обязательные промежуточные релизы: 13.0.x → 13.1.x → 13.8.x → 13.12.x → 14.0.x → 14.3.x → 14.9.x → 14.10.x → 15.0.x → 15.4.x → 15.11.x → 16.3.x → 16.7.x → 16.11.x → 17.0.x → 17.3.x → 17.5.x → 17.8.x → 17.11.x → 18.0.x → 18.2.x → 18.4.x. Условные остановки (15.1.x, 16.0.x, 16.1.x, 16.2.x, 17.1.x) включены по умолчанию и управляются параметром `INCLUDE_OPTIONAL_STOPS` в `conf/settings.env`.

## Особенности

- Перед каждым переходом на новую ветку PostgreSQL скрипт автоматически сверяет версии данных и бинарников, подбирает корректные каталоги `--old-bindir`/`--new-bindir` для `pg-upgrade` и выводит подробный лог проверок прямо в терминал.
    
## Быстрый старт
```bash
# 1) Распаковать архив в /root (или любую директорию)
tar -xzf gitlab-migrate-modular.tar.gz -C /root

# 2) Проверить/поправить конфиг (путь BACKUPS_SRC и порты)
nano /root/gitlab-migrate/conf/settings.env

# 3) Запуск
bash /root/gitlab-migrate/bin/gitlab-migrate.sh

# 4) При наличии старых данных ответьте `y` на вопрос очистки — это эквивалент `--clean`
#    или запустите сразу в неинтерактивном режиме:
bash /root/gitlab-migrate/bin/gitlab-migrate.sh --clean

# 5) После первого восстановления скрипт сохранит локальный снимок `/srv/gitlab-snapshot`.
#    Повторный запуск предложит восстановить данные из этого снимка и продолжит миграцию
#    со следующего шага без повторного распаковки исходного бэкапа.
```

В каталоге, указанном в `BACKUPS_SRC`, должны находиться архив бэкапа `*_gitlab_backup.tar*` и файл `gitlab_config.tar` с `gitlab.rb` и `gitlab-secrets.json`.

## Настройка целевой версии
В конфиге `conf/settings.env` задайте `TARGET_VERSION`. Допустимы варианты:

- `latest` (по умолчанию) — пройти всю лестницу до актуального финального релиза, зарегистрированного в `lib/upgrade.sh`.
- Версия без суффикса (например, `17.11` или `18.2`) — дойти до последнего патча указанной серии.
- Полная версия с патчем (например, `18.4.1` или `16.11.10`).

После изменения переменной перезапустите `bin/gitlab-migrate.sh`. Скрипт автоматически подрежет лестницу апгрейдов до указанного предела.
